FROM golang:1.13.1-alpine3.10 as builder

ENV PILOT_DIR /go/src/github.com/AliyunContainerService/log-pilot
ARG GOOS=linux
ARG GOARCH=amd64
RUN set -ex && apk add --no-cache make git build-base
WORKDIR $PILOT_DIR
COPY . $PILOT_DIR
RUN go install -gcflags "all=-N -l"

# Compile Delve
RUN go get -u github.com/derekparker/delve/cmd/dlv

FROM alpine:3.6
EXPOSE 40000

# Allow delve to run on Alpine based containers.
RUN apk add --no-cache libc6-compat

COPY assets/glibc/glibc-2.26-r0.apk /tmp/
RUN apk update && \ 
    apk add python && \
    apk add ruby-json ruby-irb && \
    apk add build-base ruby-dev && \
    apk add python && \
    apk add lsof && \
    apk add ca-certificates wget && \
    gem install fluentd -v 1.2.6 --no-ri --no-rdoc && \
    gem install fluent-plugin-elasticsearch -v ">=2.0.0" --no-ri --no-rdoc && \
    gem install gelf -v "~> 3.0.0" --no-ri --no-rdoc && \
    gem install aliyun_sls_sdk -v ">=0.0.9" --no-ri --no-rdoc && \
    gem install remote_syslog_logger -v ">=1.0.1" --no-ri --no-rdoc && \
    gem install fluent-plugin-remote_syslog -v ">=0.2.1" --no-ri --no-rdoc && \
    gem install fluent-plugin-kafka --no-ri --no-rdoc && \
    gem install fluent-plugin-flowcounter --no-ri --no-rdoc && \
    apk del build-base ruby-dev && \
    rm -rf /root/.gem && \
    apk add curl openssl && \
    rm -rf /tmp/glibc-2.26-r0.apk

COPY --from=builder /go/bin/log-pilot /pilot/pilot
COPY --from=builder /go/bin/dlv /pilot/dlv
COPY assets/entrypoint assets/fluentd/ assets/healthz /pilot/
RUN mkdir -p /etc/fluentd && \
    mv /pilot/plugins /etc/fluentd/ && \
    chmod +x /pilot/pilot /pilot/entrypoint /pilot/healthz /pilot/config.fluentd

HEALTHCHECK CMD /pilot/healthz

VOLUME /etc/fluentd/conf.d
VOLUME /pilot/pos
WORKDIR /pilot/
ENV PILOT_TYPE=fluentd
ENTRYPOINT ["/pilot/entrypoint"]
